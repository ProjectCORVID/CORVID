module.exports = function makeLineParser(next) {
  var buffer = '';

  return function (data) {
    var idx, line;
    var newLine = '\n';

    console.log('Received data: ' + data);

    data = buffer + data;

    while ((idx = data.indexOf(newLine)) > -1) {
      line = data.slice(0, idx);
      data = data.slice(idx + newLine.length);

      try {
        console.log('Calling user parser with ' + line);
        next = next(line) || next;
      } catch (e) {
        console.log(e);
      }
    }

    buffer = data;
  }
};
