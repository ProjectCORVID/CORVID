var CORVIDSession = module.exports = function(stream, parserFactory) {
  if (!(this instanceof CORVIDSession))
    return new CORVIDSession(stream, parserFactory);

  this.newline = '\n';
  this.parser = function () {};
  this.stream = stream;
  this.initStream();
  this.parserFactory = parserFactory;
}

CORVIDSession.prototype = {
  initStream: function () {
    // Currently assumes telnet socket. Should be made more flexible.
    var socket = this.stream;

    socket.do.transmit_binary();
    socket.do.window_size();
    socket.on('window_size', this.resize);
  },
  
  resize: function (e) {
    if (e.command == 'sb') {
      this.width = e.width;
      this.height = e.height;
    }
  },

  write: function (d) {
    this.stream.write(d);
  },

  writeLine: function (l) {
    this.write(l + this.newline);
  },

  writeLines: function (ll) {
    var lines = ll;

    if (typeof ll === 'string')
      lines = Array.prototype.slice.apply(arguments);

    this.writeLine(lines.join(this.newLine));
  },

  data: function (d) {
    this.parser(d);
  },

  connected: function () {
    this.writeLines("", "Welcome to CORVID!", "");
    this.parser = this.parserFactory(this);
    this.stream.on('data', this.data);
  }
};

