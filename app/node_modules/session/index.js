var CORVIDSession = module.exports = function(stream, parserFactory) {
  if (!(this instanceof CORVIDSession))
    return new CORVIDSession(stream, parserFactory);

  this.newline = '\n';
  this.parser = function () {};
  this.stream = stream;
  this.initStream();
}

CORVIDSession.prototype = {
  initStream: function () {
    // Currently assumes telnet socket. Should be made more flexible.
    var socket = this.stream;

    socket.do.transmit_binary();
    socket.do.window_size();
    socket.on('window_size', this.resize);
  },
  
  resize: function (e) {
      if (e.command == 'sb') {
        this.width = e.width;
        this.height = e.height;
      }
    });
  },

  write: function (d) {
    stream.write(d);
  },

  writeLine: function (l) {
    stream.write(l + this.newline);
  },

  writeLines: function (ll) {
    ll.forEach(writeLine);
  },

  data: function (d) {
    this.parser(d);
  },

  connected: function () {
    this.writeLines("", "Welcome to CORVID!", "");
    this.parser = parserFactory(this);
    stream.on('data', this.data);
  }
};

